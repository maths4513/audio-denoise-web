<!DOCTYPE html>
<html>
<head>
    <title>音频降噪 (Demucs + ffmpeg)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="container py-4">
    <h2>音频降噪 (Demucs + ffmpeg)</h2>
    <form id="upload-form">
        <input type="file" id="file" name="file" required class="form-control mb-3">
        <button class="btn btn-primary" type="submit">上传并降噪</button>
    </form>

    <div id="status" class="mt-4"></div>
    <div id="visuals" class="mt-4"></div>

    <script>
        let rawFileName = null;

        const form = document.getElementById("upload-form");
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const file = document.getElementById("file").files[0];
            const formData = new FormData();
            formData.append("file", file);

            document.getElementById("status").innerHTML = "<p>上传中...</p>";
            document.getElementById("visuals").innerHTML = "";
            const resp = await fetch("/upload", {method: "POST", body: formData});
            const data = await resp.json();
            if (data.task_id) {
                rawFileName = data.raw_file; // 保存原始音频文件名
                pollStatus(data.task_id);
            }
        });

        async function pollStatus(task_id) {
            const statusDiv = document.getElementById("status");
            const visualsDiv = document.getElementById("visuals");
            const interval = setInterval(async () => {
                const resp = await fetch(`/status/${task_id}`);
                const data = await resp.json();
                if (data.state === "progress") {
                    statusDiv.innerHTML = `<p>处理中: ${data.meta.msg}</p>`;
                } else if (data.state === "done") {
                    clearInterval(interval);
                    statusDiv.innerHTML = `<h4>✅ 完成: <a href="/download/${data.file}" download>下载降噪音频</a></h4>`;
                    visualsDiv.innerHTML = `
                        <h5>🎧 原始音频</h5>
                        <audio controls src="/download/${rawFileName}" class="w-100 mb-3"></audio>
                        <img src="/download/${data.wave_images.raw_wave}" class="img-fluid mb-2">
                        <img src="/download/${data.wave_images.raw_spec}" class="img-fluid mb-4">
                        
                        <h5>🎧 降噪后音频</h5>
                        <audio controls src="/download/${data.file}" class="w-100 mb-3"></audio>
                        <img src="/download/${data.wave_images.denoise_wave}" class="img-fluid mb-2">
                        <img src="/download/${data.wave_images.denoise_spec}" class="img-fluid">
                    `;
                } else if (data.state === "pending") {
                    statusDiv.innerHTML = "<p>排队中...</p>";
                }
            }, 2000);
        }
    </script>
</body>
</html>
