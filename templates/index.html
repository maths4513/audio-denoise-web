<!DOCTYPE html>
<html>
<head>
    <title>éŸ³é¢‘é™å™ª (Demucs + ffmpeg)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="container py-4">
    <h2>éŸ³é¢‘é™å™ª (Demucs + ffmpeg)</h2>
    <form id="upload-form">
        <input type="file" id="file" name="file" required class="form-control mb-3">
        <button class="btn btn-primary" type="submit">ä¸Šä¼ å¹¶é™å™ª</button>
    </form>

    <div id="status" class="mt-4"></div>
    <div id="visuals" class="mt-4"></div>

    <script>
        let rawFileName = null;

        const form = document.getElementById("upload-form");
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const file = document.getElementById("file").files[0];
            const formData = new FormData();
            formData.append("file", file);

            document.getElementById("status").innerHTML = "<p>ä¸Šä¼ ä¸­...</p>";
            document.getElementById("visuals").innerHTML = "";
            const resp = await fetch("/upload", {method: "POST", body: formData});
            const data = await resp.json();
            if (data.task_id) {
                rawFileName = data.raw_file; // ä¿å­˜åŸå§‹éŸ³é¢‘æ–‡ä»¶å
                pollStatus(data.task_id);
            }
        });

        async function pollStatus(task_id) {
            const statusDiv = document.getElementById("status");
            const visualsDiv = document.getElementById("visuals");
            const interval = setInterval(async () => {
                const resp = await fetch(`/status/${task_id}`);
                const data = await resp.json();
                if (data.state === "progress") {
                    statusDiv.innerHTML = `<p>å¤„ç†ä¸­: ${data.meta.msg}</p>`;
                } else if (data.state === "done") {
                    clearInterval(interval);
                    statusDiv.innerHTML = `<h4>âœ… å®Œæˆ: <a href="/download/${data.file}" download>ä¸‹è½½é™å™ªéŸ³é¢‘</a></h4>`;
                    visualsDiv.innerHTML = `
                        <h5>ğŸ§ åŸå§‹éŸ³é¢‘</h5>
                        <audio controls src="/download/${rawFileName}" class="w-100 mb-3"></audio>
                        <img src="/download/${data.wave_images.raw_wave}" class="img-fluid mb-2">
                        <img src="/download/${data.wave_images.raw_spec}" class="img-fluid mb-4">
                        
                        <h5>ğŸ§ é™å™ªåéŸ³é¢‘</h5>
                        <audio controls src="/download/${data.file}" class="w-100 mb-3"></audio>
                        <img src="/download/${data.wave_images.denoise_wave}" class="img-fluid mb-2">
                        <img src="/download/${data.wave_images.denoise_spec}" class="img-fluid">
                    `;
                } else if (data.state === "pending") {
                    statusDiv.innerHTML = "<p>æ’é˜Ÿä¸­...</p>";
                }
            }, 2000);
        }
    </script>
</body>
</html>
